function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,i=function(){};return{s:i,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){l=!0,n=e},f:function(){try{o||null==r.return||r.return()}finally{if(l)throw n}}}}function changeRange(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=e.lastChild;setTimeout((function(){var e=new Range;e.setStart(r,1),e.setEnd(r,1),(t=t||getSelection())&&(t.removeAllRanges(),t.addRange(e))}),100)}var hexToRgb=function(e){return e.replace(/^#(\w{2})(\w{2})(\w{2})$/g,(function(e,t,r,a){return"rgb(".concat(parseInt(t,16),", ").concat(parseInt(r,16),", ").concat(parseInt(a,16),")")}))};function isParentNode(e,t){for(var r=t.parentNode;r;){if(r===e)return!0;null!==r&&(r=r.parentNode)}return!1}function selectionInEditor(e,t){var r=t.commonAncestorContainer;return e===r||isParentNode(e,r)}function isLastChild(e){var t,r;return null===(t=e.parentElement)||void 0===t||t.normalize(),(null===(r=e.parentElement)||void 0===r?void 0:r.lastChild)===e}function isEmpty(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"div";return""===e.innerHTML||"<br>"===e.innerHTML||e.innerHTML==="<".concat(t,"><br></").concat(t,">")}function createOutterPlaceholder(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"请输入...",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"div",r=document.createElement(t);return r.style.cssText="position: absolute;\n                                    left: 20px;\n                                    top: 20px;\n                                    color: gray;\n                                    pointer-events: none;\n                                    position: absolute;",r.appendChild(document.createTextNode(e)),r}var insertTagType=["img","hr","table"],placeholderMark="\ufeff";function isPlaceholder(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"div";return e.innerHTML==="<".concat(t,">").concat(placeholderMark,"</").concat(t,">")}function createInnerPlaceholder(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",t=document.createElement(e),r=document.createTextNode(placeholderMark);return t.appendChild(r),t}function togglePlaceholder(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div";if(isEmpty(t,r)){e.style.display="block",t.firstChild&&t.firstChild.remove();var a=createInnerPlaceholder(r);t.appendChild(a),changeRange(a)}else isPlaceholder(t,r)||(e.style.display="none")}var defaultConfig={autoFocus:!1,blockTag:"div",placeholderText:"请输入..."},QkEditor=function(){function e(t,r){var a=this;_classCallCheck(this,e),_defineProperty(this,"blockTag","div"),_defineProperty(this,"historyRange",[]);var i=Object.assign({},defaultConfig,r);this.blockTag=i.blockTag;var n="string"==typeof t?document.getElementById(t):t;if(n){n.style.position="relative";var o=document.createElement("div");o.contentEditable="true",o.style.cssText="\n                                    height: 100%;\n                                    outline: none;\n                                    overflow-y: auto;\n                                    padding: 20px;",n.appendChild(o),this.root=o;var l=createOutterPlaceholder(i.placeholderText,i.blockTag);o.after(l),this.placeholder=l;var s=createInnerPlaceholder(this.blockTag);o.appendChild(s),i.autoFocus&&changeRange(s),new MutationObserver((function(){togglePlaceholder(a.placeholder,o,i.blockTag);var e=i.onChange;e&&"function"==typeof e&&e(isPlaceholder(o,a.blockTag)?"":o.innerHTML)})).observe(o,{childList:!0,attributes:!0,subtree:!0,characterData:!0}),this.root.addEventListener("keydown",(function(e){if("Enter"===e.key){var t=getSelection(),r=t.getRangeAt(0);if(r.commonAncestorContainer===a.root){e.preventDefault();var n=a.root.childNodes[r.startOffset],o=createInnerPlaceholder(i.blockTag);a.root.insertBefore(o,n),changeRange(o,t)}}})),document.addEventListener("selectionchange",(function(){var e=getSelection();if(e&&"None"!==e.type){var t=e.getRangeAt(0);selectionInEditor(a.root,t)&&(a.historyRange.length>20&&a.historyRange.shift(),a.historyRange.push(t))}}))}else console.error("dom不存在！")}return _createClass(e,[{key:"isActive",value:function(e){var t=this.markTag,r=this.markTagStyle,a=this.markTagAttr;if(3===e.nodeType)return!1;if(e instanceof HTMLElement&&e.tagName.toLowerCase()===t){if(r)for(var i in r)if(e.style[i]!==r[i]&&!(r[i].indexOf("#")>-1&&e.style[i]===hexToRgb(r[i])))return!1;if(a)for(var n in a)if(e[n]!==a[n])return!1;return!0}return!1}},{key:"hasActive",value:function(e){for(var t=e;!this.isActive(t)&&t!==this.root;)t=t.parentElement;return t!==this.root}},{key:"getActiveNode",value:function(e){for(var t=e.parentElement;!this.isActive(t);)t=t.parentElement;return t}},{key:"createMarkTag",value:function(){var e=this.markTag,t=this.markTagStyle,r=this.markTagAttr,a=document.createElement(e);if(t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(a.style[i]=t[i]);if(r)for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(a[n]=r[n]);return a}},{key:"removeSiblingsMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"left",a="left"===r?e.firstChild:e.lastChild;a&&a!==t&&!isParentNode(a,t);){var i="left"===r?a.nextSibling:a.previousSibling;this.removeAllMark(a),a=i}a&&isParentNode(a,t)&&this.removeSiblingsMark(a,t,r)}},{key:"addStartMark",value:function(e,t){if(e===t){var r=this.createMarkTag();t.after(r),r.appendChild(t)}else this.removeSiblingsMark(e,t,"right"),this.addRightMark(e,t,!0)}},{key:"addEndMark",value:function(e,t){if(e===t){var r=this.createMarkTag();t.after(r),r.appendChild(t)}else this.removeSiblingsMark(e,t),this.addLeftMark(e,t,!0)}},{key:"addMark",value:function(e){if(3===e.nodeType){var t=this.createMarkTag();e.after(t),t.appendChild(e)}else if(!this.isActive(e)){if(insertTagType.indexOf(e.tagName.toLocaleLowerCase())>-1)return;this.removeAllMark(e);for(var r=this.createMarkTag();e.firstChild;)r.appendChild(e.firstChild);e.appendChild(r)}}},{key:"addLeftMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=this.createMarkTag();e.firstChild&&e.firstChild!==t&&!isParentNode(e.firstChild,t);)a.appendChild(e.firstChild);e.firstChild!==t?this.addLeftMark(e.firstChild,t,r):r&&a.appendChild(t),a.firstChild&&e.prepend(a)}},{key:"addRightMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=this.createMarkTag();e.lastChild&&e.lastChild!==t&&!isParentNode(e.lastChild,t);)a.prepend(e.lastChild);e.lastChild!==t?this.addRightMark(e.lastChild,t,r):r&&a.prepend(t),a.firstChild&&e.appendChild(a)}},{key:"removeRightMark",value:function(e,t){for(;e.lastChild&&e.lastChild!==t&&!isParentNode(e.lastChild,t);)e.after(e.lastChild);e.lastChild!==t&&this.addLeftMark(e.lastChild,t),e.after(e.lastChild),e.firstChild||e.remove()}},{key:"removeLeftMark",value:function(e,t){for(;e.firstChild&&e.firstChild!==t&&!isParentNode(e.firstChild,t);)e.before(e.firstChild);e.firstChild!==t&&this.addRightMark(e.firstChild,t),e.before(e.firstChild),e.firstChild||e.remove()}},{key:"removeSelectedMark",value:function(e,t,r){for(var a=this.createMarkTag();e.lastChild&&e.lastChild!==r&&!isParentNode(e.lastChild,r);)a.prepend(e.lastChild);for(a.firstChild&&e.after(a),e.lastChild!==r&&this.addRightMark(e.lastChild,r);e.lastChild&&e.lastChild!==t&&!isParentNode(e.lastChild,t);)e.after(e.lastChild);e.lastChild!==t&&this.addLeftMark(e.lastChild,t),e.after(e.lastChild),e.firstChild||e.remove()}},{key:"removeAllMark",value:function(e){if(3!==e.nodeType)if(this.isActive(e)){for(;e.lastChild;)e.after(e.lastChild);e.remove()}else if(e.childNodes.length>0)for(var t=0,r=Array.from(e.childNodes);t<r.length;t++){var a=r[t];this.removeAllMark(a)}}},{key:"copyRightNode",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=this.markTagStyle,i=this.markTagAttr,n=document.createElement(e.tagName);if(a)for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&e.style[o]&&(n.style[o]=e.style[o]);if(i)for(var l in i)Object.prototype.hasOwnProperty.call(i,l)&&e.style[l]&&(n[l]=e[l]);for(;e.lastChild&&e.lastChild!==t&&!isParentNode(e.lastChild,t);)n.prepend(e.lastChild);return r&&e.lastChild===t?n.prepend(t):isParentNode(e.lastChild,t)&&n.prepend(this.copyRightNode(e.lastChild,t,r)||""),n.firstChild?n:null}},{key:"setRange",value:function(){var e;return this.historyRange.length>0?e=this.historyRange.at(-1):(this.root.focus(),e=getSelection().getRangeAt(0)),e}},{key:"getRange",value:function(){var e,t=getSelection();return"None"===t.type?e=this.setRange():(e=t.getRangeAt(0),selectionInEditor(this.root,e)||(e=this.setRange())),{root:this.root,range:e,startNode:e.startContainer,endNode:e.endContainer,commonNode:e.commonAncestorContainer}}},{key:"setTextStyle",value:function(e,t,r){this.markTag=e,this.markTagStyle=t,this.markTagAttr=r;var a=this.getRange(),i=a.root,n=a.range,o=a.commonNode,l=a.startNode,s=a.endNode,d=o.childNodes,h=n.startOffset,f=n.endOffset,c=0,v=0;if(3===l.nodeType){if(n.collapsed){var p=document.createTextNode(placeholderMark);if(this.hasActive(l)){var u=this.getActiveNode(l);if(h===l.length){for(var g=l;isLastChild(g)&&g!==u;)g=g.parentElement;g!==u&&u.after(this.copyRightNode(u,g.nextSibling,!0)||""),u.after(p)}else 0===h?u.before(p):(l=l.splitText(h),u.after(this.copyRightNode(u,l,!0)),u.after(p))}else{var m=this.createMarkTag();(l=l.splitText(h)).previousSibling.after(m),m.appendChild(p)}return n.setStart(p,1),n.setEnd(p,1),void i.focus()}if(l===s){var y;f<s.length&&s.splitText(f),h>0&&(l=l.splitText(h));for(var k=!1,C=l.parentElement;C!==i;){if(this.isActive(C)){k=!0;break}C=C.parentElement}if(k){for(var b=this.createMarkTag();C.lastChild&&C.lastChild!==l&&!isParentNode(C.lastChild,l);)b.prepend(C.lastChild);b.firstChild&&C.after(b),C.lastChild!==l&&this.addRightMark(C.lastChild,l),C.after(C.lastChild),C.firstChild||C.remove()}else{var T=this.createMarkTag();l.after(T),T.appendChild(l)}return n.setStart(l,0),n.setEnd(l,l.length),null===(y=l.parentElement)||void 0===y||y.normalize(),void i.focus()}f<s.length&&(s=s.splitText(f).previousSibling),h>0&&(l=l.splitText(h));for(var M=0;M<d.length;M++)if((d[M]===l||isParentNode(d[M],l))&&(c=M),d[M]===s||isParentNode(d[M],s)){v=M;break}for(var E=Array.from(d).slice(c,v+1),N=!1,A=!1,P=l.parentElement;P!==i;){if(this.isActive(P)){N=!0;break}P=P.parentElement}for(var R=s.parentElement;R!==i;){if(this.isActive(R)){A=!0;break}R=R.parentElement}if(N||A)if(P===R)this.removeSelectedMark(P,l,s);else{var S=E.shift();N?(this.removeSiblingsMark(S,P,"right"),this.removeRightMark(P,l)):this.removeSiblingsMark(S,l,"right");var x=E.pop();A?(this.removeSiblingsMark(x,R),this.removeLeftMark(R,s)):this.removeSiblingsMark(x,s);var O,L=_createForOfIteratorHelper(E);try{for(L.s();!(O=L.n()).done;){var w=O.value;this.removeAllMark(w)}}catch(e){L.e(e)}finally{L.f()}}else{this.addStartMark(E.shift(),l),this.addEndMark(E.pop(),s);var I,_=_createForOfIteratorHelper(E);try{for(_.s();!(I=_.n()).done;){var j=I.value;this.addMark(j)}}catch(e){_.e(e)}finally{_.f()}}n.setStart(l,0),n.setEnd(s,s.length),i.normalize(),i.focus()}}},{key:"setParagraphStyle",value:function(e,t){var r=this.getRange(),a=r.root,i=r.commonNode,n=r.startNode,o=r.endNode,l=i.childNodes,s=0,d=0;if(i===a){for(var h=0;h<l.length;h++)if((l[h]===n||isParentNode(l[h],n))&&(s=h),l[h]===o||isParentNode(l[h],o)){d=h;break}for(var f=s;f<=d;f++)l[f].style[e]=t}else{for(var c=i;c.parentElement!==a;)c=c.parentElement;c.style[e]=t}a.focus()}},{key:"insertElement",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=this.getRange(),n=i.root,o=i.range,l=i.startNode,s=i.endNode,d=i.commonNode,h=o.startOffset,f=o.endOffset;if(t="string"==typeof e?document.createElement(e):e,Object.keys(r).forEach((function(e){t.setAttribute(e,r[e])})),Object.keys(a).forEach((function(e){t.style[e]=a[e]})),o.collapsed){var c=l;if(0===h)for(;c!==n&&c.parentElement!==n;)c=c.parentElement;else if(h===l.length){for(;isLastChild(c)&&c!==n&&c.parentElement!==n;)c=c.parentElement;if(c.parentElement!==n){var v=c;for(c=c.parentElement;c.parentElement!==n;)c=c.parentElement;c.after(this.copyRightNode(c,v)||"")}}else{for(;c!==n&&c.parentElement!==n;)c=c.parentElement;var p;l===s?(s.splitText(f),p=l.splitText(h)):p=s.splitText(f).previousSibling,c.after(this.copyRightNode(c,p)||"")}c.after(t)}else if(d===n)o.deleteContents(),o.insertNode(t);else{for(var u,g=l;g.parentElement!==n;)g=g.parentElement;l===s?(s.splitText(f),u=l.splitText(h)):u=s.splitText(f).previousSibling,o.deleteContents(),g.after(this.copyRightNode(g,u)||""),g.after(t)}if(t.parentNode&&null===t.nextSibling){var m=document.createElement(this.blockTag);m.appendChild(document.createTextNode(placeholderMark)),t.after(m)}n.focus()}},{key:"setEditorContent",value:function(e){this.root.innerHTML=e}},{key:"clear",value:function(){this.root.innerHTML="",this.root.focus()}}]),e}();export{QkEditor as default};