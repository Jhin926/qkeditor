function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,n=function(){};return{s:n,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){l=!0,i=e},f:function(){try{o||null==r.return||r.return()}finally{if(l)throw i}}}}function changeRange(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=e.lastChild;setTimeout((function(){var e=new Range;e.setStart(r,1),e.setEnd(r,1),t||(t=getSelection()),t&&(t.removeAllRanges(),t.addRange(e))}),100)}var hexToRgb=function(e){return e.replace(/^#(\w{2})(\w{2})(\w{2})$/g,(function(e,t,r,a){return"rgb(".concat(parseInt(t,16),", ").concat(parseInt(r,16),", ").concat(parseInt(a,16),")")}))};function isParentNode(e,t){for(var r=t.parentNode;r;){if(r===e)return!0;null!==r&&(r=r.parentNode)}return!1}function isLastChild(e){var t,r;return null===(t=e.parentElement)||void 0===t||t.normalize(),(null===(r=e.parentElement)||void 0===r?void 0:r.lastChild)===e}var insertTagType=["img","hr","table"];function addInsertTagType(e){insertTagType.push(e)}var autoFocus=!1;function setAutoFocus(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];autoFocus=e}var placeholderMark="\ufeff",blockTag="div";function setBlockTag(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div";blockTag=e}function isEmpty(e){return""===e.innerHTML||"<br>"===e.innerHTML||e.innerHTML==="<".concat(blockTag,"><br></").concat(blockTag,">")}function isPlaceholder(e){return e.innerHTML==="<".concat(blockTag,">").concat(placeholderMark,"</").concat(blockTag,">")}function createInnerPlaceholder(){var e=document.createElement(blockTag),t=document.createTextNode(placeholderMark);return e.appendChild(t),e}function selectionInEditor(e,t){var r=t.commonAncestorContainer;return e===r||isParentNode(e,r)}var placeholderText="请输入...";function setPlaceholderContent(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"请输入...";placeholderText=e}function createOutterPlaceholder(){var e=document.createElement(blockTag);return e.style.cssText="position: absolute;\n                                    left: 20px;\n                                    top: 20px;\n                                    color: gray;\n                                    pointer-events: none;\n                                    position: absolute;",e.appendChild(document.createTextNode(placeholderText)),e}function togglePlaceholder(e,t){if(isEmpty(t)){e.style.display="block",t.firstChild&&t.firstChild.remove();var r=createInnerPlaceholder();t.appendChild(r),changeRange(r)}else isPlaceholder(t)||(e.style.display="none")}var QkEditor=function(){function e(t){var r=this;_classCallCheck(this,e),_defineProperty(this,"config",{}),_defineProperty(this,"historyRange",[]),_defineProperty(this,"tempNodeList",[]);var a=document.getElementById(t);if(a){a.style.position="relative";var n=document.createElement("div");n.contentEditable="true",n.style.cssText="\n                                    height: 100%;\n                                    outline: none;\n                                    overflow-y: auto;\n                                    padding: 20px;",a.appendChild(n),this.root=n;var i=createOutterPlaceholder();n.after(i),this.placeholder=i;var o=createInnerPlaceholder();n.appendChild(o),autoFocus&&changeRange(o);var l=this.tempNodeList;new MutationObserver((function(){togglePlaceholder(r.placeholder,n);var e=r.config.onChange;e&&"function"==typeof e&&e(isPlaceholder(n)?"":n.innerHTML)})).observe(n,{childList:!0,attributes:!0,subtree:!0,characterData:!0}),this.root.addEventListener("keydown",(function(e){if("Enter"===e.key){var t=getSelection(),a=t.getRangeAt(0);if(a.commonAncestorContainer===r.root){e.preventDefault();var n=r.root.childNodes[a.startOffset],i=createInnerPlaceholder();r.root.insertBefore(i,n),changeRange(i,t)}}})),document.addEventListener("selectionchange",(function(){var e=getSelection();if(e&&"None"!==e.type){var t=e.getRangeAt(0);selectionInEditor(r.root,t)&&(r.historyRange.length>20&&r.historyRange.shift(),r.historyRange.push(t)),(t.startContainer!==t.endContainer||t.startContainer.textContent!==placeholderMark)&&1===t.endOffset&&1===t.startOffset&&l.length>0&&(t.commonAncestorContainer===l.at(-1)||isParentNode(l.at(-1),t.commonAncestorContainer)||l.forEach((function(e){e.remove()})),l.length=0,r.root.normalize())}}))}else console.error("dom不存在！")}return _createClass(e,[{key:"isActive",value:function(e){var t=this.markTag,r=this.markTagStyle,a=this.markTagAttr;if(3===e.nodeType)return!1;if(e instanceof HTMLElement&&e.tagName.toLowerCase()===t){if(r)for(var n in r)if(e.style[n]!==r[n]&&!(r[n].indexOf("#")>-1&&e.style[n]===hexToRgb(r[n])))return!1;if(a)for(var i in a)if(e[i]!==a[i])return!1;return!0}return!1}},{key:"hasActive",value:function(e){for(var t=e;!this.isActive(t)&&t!==this.root;)t=t.parentElement;return t!==this.root}},{key:"getActiveNode",value:function(e){for(var t=e.parentElement;!this.isActive(t);)t=t.parentElement;return t}},{key:"createMarkTag",value:function(){var e=this.markTag,t=this.markTagStyle,r=this.markTagAttr,a=document.createElement(e);if(t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(a.style[n]=t[n]);if(r)for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(a[i]=r[i]);return a}},{key:"removeSiblingsMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"left",a="left"===r?e.firstChild:e.lastChild;a&&a!==t&&!isParentNode(a,t);){var n="left"===r?a.nextSibling:a.previousSibling;this.removeAllMark(a),a=n}a&&isParentNode(a,t)&&this.removeSiblingsMark(a,t,r)}},{key:"addStartMark",value:function(e,t){if(e===t){var r=this.createMarkTag();t.after(r),r.appendChild(t)}else this.removeSiblingsMark(e,t,"right"),this.addRightMark(e,t,!0)}},{key:"addEndMark",value:function(e,t){if(e===t){var r=this.createMarkTag();t.after(r),r.appendChild(t)}else this.removeSiblingsMark(e,t),this.addLeftMark(e,t,!0)}},{key:"addMark",value:function(e){if(3===e.nodeType){var t=this.createMarkTag();e.after(t),t.appendChild(e)}else if(!this.isActive(e)){if(insertTagType.indexOf(e.tagName.toLocaleLowerCase())>-1)return;this.removeAllMark(e);for(var r=this.createMarkTag();e.firstChild;)r.appendChild(e.firstChild);e.appendChild(r)}}},{key:"addLeftMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=this.createMarkTag();e.firstChild&&e.firstChild!==t&&!isParentNode(e.firstChild,t);)a.appendChild(e.firstChild);e.firstChild!==t?this.addLeftMark(e.firstChild,t,r):r&&a.appendChild(t),a.firstChild&&e.prepend(a)}},{key:"addRightMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=this.createMarkTag();e.lastChild&&e.lastChild!==t&&!isParentNode(e.lastChild,t);)a.prepend(e.lastChild);e.lastChild!==t?this.addRightMark(e.lastChild,t,r):r&&a.prepend(t),a.firstChild&&e.appendChild(a)}},{key:"removeRightMark",value:function(e,t){for(;e.lastChild&&e.lastChild!==t&&!isParentNode(e.lastChild,t);)e.after(e.lastChild);e.lastChild!==t&&this.addLeftMark(e.lastChild,t),e.after(e.lastChild),e.firstChild||e.remove()}},{key:"removeLeftMark",value:function(e,t){for(;e.firstChild&&e.firstChild!==t&&!isParentNode(e.firstChild,t);)e.before(e.firstChild);e.firstChild!==t&&this.addRightMark(e.firstChild,t),e.before(e.firstChild),e.firstChild||e.remove()}},{key:"removeSelectedMark",value:function(e,t,r){for(var a=this.createMarkTag();e.lastChild&&e.lastChild!==r&&!isParentNode(e.lastChild,r);)a.prepend(e.lastChild);for(a.firstChild&&e.after(a),e.lastChild!==r&&this.addRightMark(e.lastChild,r);e.lastChild&&e.lastChild!==t&&!isParentNode(e.lastChild,t);)e.after(e.lastChild);e.lastChild!==t&&this.addLeftMark(e.lastChild,t),e.after(e.lastChild),e.firstChild||e.remove()}},{key:"removeAllMark",value:function(e){if(3!==e.nodeType)if(this.isActive(e)){for(;e.lastChild;)e.after(e.lastChild);e.remove()}else if(e.childNodes.length>0)for(var t=0,r=Array.from(e.childNodes);t<r.length;t++){var a=r[t];this.removeAllMark(a)}}},{key:"copyRightNode",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=this.markTagStyle,n=this.markTagAttr,i=document.createElement(e.tagName);if(a)for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&e.style[o]&&(i.style[o]=e.style[o]);if(n)for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&e.style[l]&&(i[l]=e[l]);for(;e.lastChild&&e.lastChild!==t&&!isParentNode(e.lastChild,t);)i.prepend(e.lastChild);return r&&e.lastChild===t?i.prepend(t):isParentNode(e.lastChild,t)&&i.prepend(this.copyRightNode(e.lastChild,t,r)||""),i.firstChild?i:null}},{key:"getRange",value:function(){var e,t=getSelection();return"None"===t.type?this.historyRange.length>0?e=this.historyRange.at(-1):(this.root.focus(),e=(t=getSelection()).getRangeAt(0)):(e=t.getRangeAt(0),selectionInEditor(this.root,e)||(this.historyRange.length>0?e=this.historyRange.at(-1):(this.root.focus(),e=(t=getSelection()).getRangeAt(0)))),{root:this.root,range:e,startNode:e.startContainer,endNode:e.endContainer,commonNode:e.commonAncestorContainer}}},{key:"setLink",value:function(e){this.historyRange.length&&this.setTextStyle("a",null,{href:e})}},{key:"setTextStyle",value:function(e,t,r){var a=this.tempNodeList;this.markTag=e,this.markTagStyle=t,this.markTagAttr=r;var n=this.getRange(),i=n.root,o=n.range,l=n.commonNode,s=n.startNode,d=n.endNode,h=l.childNodes,f=o.startOffset,c=o.endOffset,u=0,p=0;if(3===s.nodeType){if(o.collapsed){var v=document.createTextNode(placeholderMark);if(this.hasActive(s)){var g=this.getActiveNode(s);if(f===s.length){for(var m=s;isLastChild(m)&&m!==g;)m=m.parentElement;if(m!==g&&g.after(this.copyRightNode(g,m.nextSibling,!0)||""),s.textContent===placeholderMark&&a.length>0&&a.some((function(t){return t instanceof HTMLElement&&t.tagName.toLowerCase()===e}))){var y=a.find((function(t){return t instanceof HTMLElement&&t.tagName===e}));return null==y||y.remove(),void a.push(v)}g.after(v)}else 0===f?g.before(v):(s=s.splitText(f),g.after(this.copyRightNode(g,s,!0)),g.after(v));a.push(v)}else{var C=this.createMarkTag();(s=s.splitText(f)).previousSibling.after(C),C.appendChild(v),a.push(C)}return o.setStart(v,1),o.setEnd(v,1),void i.focus()}if(s===d){var k;c<d.length&&d.splitText(c),f>0&&(s=s.splitText(f));for(var T=!1,b=s.parentElement;b!==i;){if(this.isActive(b)){T=!0;break}b=b.parentElement}if(T){for(var M=this.createMarkTag();b.lastChild&&b.lastChild!==s&&!isParentNode(b.lastChild,s);)M.prepend(b.lastChild);M.firstChild&&b.after(M),b.lastChild!==s&&this.addRightMark(b.lastChild,s),b.after(b.lastChild),b.firstChild||b.remove()}else{var E=this.createMarkTag();s.after(E),E.appendChild(s)}return o.setStart(s,0),o.setEnd(s,s.length),null===(k=s.parentElement)||void 0===k||k.normalize(),void i.focus()}c<d.length&&(d=d.splitText(c).previousSibling),f>0&&(s=s.splitText(f));for(var N=0;N<h.length;N++)if((h[N]===s||isParentNode(h[N],s))&&(u=N),h[N]===d||isParentNode(h[N],d)){p=N;break}for(var A=Array.from(h).slice(u,p+1),P=!1,R=!1,S=s.parentElement;S!==i;){if(this.isActive(S)){P=!0;break}S=S.parentElement}for(var x=d.parentElement;x!==i;){if(this.isActive(x)){R=!0;break}x=x.parentElement}if(P||R)if(S===x)this.removeSelectedMark(S,s,d);else{var L=A.shift();P?(this.removeSiblingsMark(L,S,"right"),this.removeRightMark(S,s)):this.removeSiblingsMark(L,s,"right");var O=A.pop();R?(this.removeSiblingsMark(O,x),this.removeLeftMark(x,d)):this.removeSiblingsMark(O,d);var w,I=_createForOfIteratorHelper(A);try{for(I.s();!(w=I.n()).done;){var _=w.value;this.removeAllMark(_)}}catch(e){I.e(e)}finally{I.f()}}else{this.addStartMark(A.shift(),s),this.addEndMark(A.pop(),d);var H,j=_createForOfIteratorHelper(A);try{for(j.s();!(H=j.n()).done;){var F=H.value;this.addMark(F)}}catch(e){j.e(e)}finally{j.f()}}o.setStart(s,0),o.setEnd(d,d.length),i.normalize(),i.focus()}}},{key:"setParagraphStyle",value:function(e,t){var r=this.getRange(),a=r.root,n=r.commonNode,i=r.startNode,o=r.endNode,l=n.childNodes,s=0,d=0;if(n===a){for(var h=0;h<l.length;h++)if((l[h]===i||isParentNode(l[h],i))&&(s=h),l[h]===o||isParentNode(l[h],o)){d=h;break}for(var f=s;f<=d;f++)l[f].style[e]=t}else{for(var c=n;c.parentElement!==a;)c=c.parentElement;c.style[e]=t}a.focus()}},{key:"insertElement",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=this.getRange(),i=n.root,o=n.range,l=n.startNode,s=n.endNode,d=n.commonNode,h=o.startOffset,f=o.endOffset;if(t="string"==typeof e?document.createElement(e):e,Object.keys(r).forEach((function(e){t.setAttribute(e,r[e])})),Object.keys(a).forEach((function(e){t.style[e]=a[e]})),o.collapsed){var c=l;if(0===h)for(;c!==i&&c.parentElement!==i;)c=c.parentElement;else if(h===l.length){for(;isLastChild(c)&&c!==i&&c.parentElement!==i;)c=c.parentElement;if(c.parentElement!==i){var u=c;for(c=c.parentElement;c.parentElement!==i;)c=c.parentElement;c.after(this.copyRightNode(c,u)||"")}}else{for(;c!==i&&c.parentElement!==i;)c=c.parentElement;var p;l===s?(s.splitText(f),p=l.splitText(h)):p=s.splitText(f).previousSibling,c.after(this.copyRightNode(c,p)||"")}c.after(t)}else if(d===i)o.deleteContents(),o.insertNode(t);else{for(var v,g=l;g.parentElement!==i;)g=g.parentElement;l===s?(s.splitText(f),v=l.splitText(h)):v=s.splitText(f).previousSibling,o.deleteContents(),g.after(this.copyRightNode(g,v)||""),g.after(t)}if(t.parentNode&&null===t.nextSibling){var m=document.createElement(blockTag);m.appendChild(document.createTextNode(placeholderMark)),t.after(m)}i.focus()}},{key:"setEditorContent",value:function(e){this.root.innerHTML=e}},{key:"clear",value:function(){this.root.innerHTML="",this.root.focus()}}]),e}();export{addInsertTagType,QkEditor as default,setAutoFocus,setBlockTag,setPlaceholderContent};