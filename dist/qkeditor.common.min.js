!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).QkEditor={})}(this,(function(e){"use strict";function t(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function i(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,a=function(){};return{s:a,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,l=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return l=e.done,e},e:function(e){s=!0,o=e},f:function(){try{l||null==r.return||r.return()}finally{if(s)throw o}}}}function a(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=e.lastChild;setTimeout((function(){var e=new Range;e.setStart(r,1),e.setEnd(r,1),t||(t=getSelection()),t&&(t.removeAllRanges(),t.addRange(e))}),100)}function o(e,t){for(var r=t.parentNode;r;){if(r===e)return!0;null!==r&&(r=r.parentNode)}return!1}function l(e){var t,r;return null===(t=e.parentElement)||void 0===t||t.normalize(),(null===(r=e.parentElement)||void 0===r?void 0:r.lastChild)===e}var s=["img","hr","table"],d=!1,f="\ufeff",h="div";function c(e){return e.innerHTML==="<".concat(h,">").concat(f,"</").concat(h,">")}function u(){var e=document.createElement(h),t=document.createTextNode(f);return e.appendChild(t),e}function v(e,t){var r=t.commonAncestorContainer;return e===r||o(e,r)}var p="请输入...";var g=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r(this,"config",{}),r(this,"historyRange",[]),r(this,"tempNodeList",[]);var i,l=document.getElementById(t);if(l){l.style.position="relative";var s=document.createElement("div");s.contentEditable="true",s.style.cssText="\n                                    height: 100%;\n                                    outline: none;\n                                    overflow-y: auto;\n                                    padding: 20px;",l.appendChild(s),this.root=s;var g=((i=document.createElement(h)).style.cssText="position: absolute;\n                                    left: 20px;\n                                    top: 20px;\n                                    color: gray;\n                                    pointer-events: none;\n                                    position: absolute;",i.appendChild(document.createTextNode(p)),i);s.after(g),this.placeholder=g;var m=u();s.appendChild(m),d&&a(m);var y=this.tempNodeList;new MutationObserver((function(){!function(e,t){if(function(e){return""===e.innerHTML||"<br>"===e.innerHTML||e.innerHTML==="<".concat(h,"><br></").concat(h,">")}(t)){e.style.display="block",t.firstChild&&t.firstChild.remove();var r=u();t.appendChild(r),a(r)}else c(t)||(e.style.display="none")}(n.placeholder,s);var e=n.config.onChange;e&&"function"==typeof e&&e(c(s)?"":s.innerHTML)})).observe(s,{childList:!0,attributes:!0,subtree:!0,characterData:!0}),this.root.addEventListener("keydown",(function(e){if("Enter"===e.key){var t=getSelection(),r=t.getRangeAt(0);if(r.commonAncestorContainer===n.root){e.preventDefault();var i=n.root.childNodes[r.startOffset],o=u();n.root.insertBefore(o,i),a(o,t)}}})),document.addEventListener("selectionchange",(function(){var e=getSelection();if(e&&"None"!==e.type){var t=e.getRangeAt(0);v(n.root,t)&&(n.historyRange.length>20&&n.historyRange.shift(),n.historyRange.push(t)),(t.startContainer!==t.endContainer||t.startContainer.textContent!==f)&&1===t.endOffset&&1===t.startOffset&&y.length>0&&(t.commonAncestorContainer===y.at(-1)||o(y.at(-1),t.commonAncestorContainer)||y.forEach((function(e){e.remove()})),y.length=0,n.root.normalize())}}))}else console.error("dom不存在！")}var n,g;return n=e,g=[{key:"isActive",value:function(e){var t,r=this.markTag,n=this.markTagStyle,i=this.markTagAttr;if(3===e.nodeType)return!1;if(e instanceof HTMLElement&&e.tagName.toLowerCase()===r){if(n)for(var a in n)if(e.style[a]!==n[a]&&!(n[a].indexOf("#")>-1&&e.style[a]===(t=n[a],t.replace(/^#(\w{2})(\w{2})(\w{2})$/g,(function(e,t,r,n){return"rgb(".concat(parseInt(t,16),", ").concat(parseInt(r,16),", ").concat(parseInt(n,16),")")})))))return!1;if(i)for(var o in i)if(e[o]!==i[o])return!1;return!0}return!1}},{key:"hasActive",value:function(e){for(var t=e;!this.isActive(t)&&t!==this.root;)t=t.parentElement;return t!==this.root}},{key:"getActiveNode",value:function(e){for(var t=e.parentElement;!this.isActive(t);)t=t.parentElement;return t}},{key:"createMarkTag",value:function(){var e=this.markTag,t=this.markTagStyle,r=this.markTagAttr,n=document.createElement(e);if(t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n.style[i]=t[i]);if(r)for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(n[a]=r[a]);return n}},{key:"removeSiblingsMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"left",n="left"===r?e.firstChild:e.lastChild;n&&n!==t&&!o(n,t);){var i="left"===r?n.nextSibling:n.previousSibling;this.removeAllMark(n),n=i}n&&o(n,t)&&this.removeSiblingsMark(n,t,r)}},{key:"addStartMark",value:function(e,t){if(e===t){var r=this.createMarkTag();t.after(r),r.appendChild(t)}else this.removeSiblingsMark(e,t,"right"),this.addRightMark(e,t,!0)}},{key:"addEndMark",value:function(e,t){if(e===t){var r=this.createMarkTag();t.after(r),r.appendChild(t)}else this.removeSiblingsMark(e,t),this.addLeftMark(e,t,!0)}},{key:"addMark",value:function(e){if(3===e.nodeType){var t=this.createMarkTag();e.after(t),t.appendChild(e)}else if(!this.isActive(e)){if(s.indexOf(e.tagName.toLocaleLowerCase())>-1)return;this.removeAllMark(e);for(var r=this.createMarkTag();e.firstChild;)r.appendChild(e.firstChild);e.appendChild(r)}}},{key:"addLeftMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.createMarkTag();e.firstChild&&e.firstChild!==t&&!o(e.firstChild,t);)n.appendChild(e.firstChild);e.firstChild!==t?this.addLeftMark(e.firstChild,t,r):r&&n.appendChild(t),n.firstChild&&e.prepend(n)}},{key:"addRightMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.createMarkTag();e.lastChild&&e.lastChild!==t&&!o(e.lastChild,t);)n.prepend(e.lastChild);e.lastChild!==t?this.addRightMark(e.lastChild,t,r):r&&n.prepend(t),n.firstChild&&e.appendChild(n)}},{key:"removeRightMark",value:function(e,t){for(;e.lastChild&&e.lastChild!==t&&!o(e.lastChild,t);)e.after(e.lastChild);e.lastChild!==t&&this.addLeftMark(e.lastChild,t),e.after(e.lastChild),e.firstChild||e.remove()}},{key:"removeLeftMark",value:function(e,t){for(;e.firstChild&&e.firstChild!==t&&!o(e.firstChild,t);)e.before(e.firstChild);e.firstChild!==t&&this.addRightMark(e.firstChild,t),e.before(e.firstChild),e.firstChild||e.remove()}},{key:"removeSelectedMark",value:function(e,t,r){for(var n=this.createMarkTag();e.lastChild&&e.lastChild!==r&&!o(e.lastChild,r);)n.prepend(e.lastChild);for(n.firstChild&&e.after(n),e.lastChild!==r&&this.addRightMark(e.lastChild,r);e.lastChild&&e.lastChild!==t&&!o(e.lastChild,t);)e.after(e.lastChild);e.lastChild!==t&&this.addLeftMark(e.lastChild,t),e.after(e.lastChild),e.firstChild||e.remove()}},{key:"removeAllMark",value:function(e){if(3!==e.nodeType)if(this.isActive(e)){for(;e.lastChild;)e.after(e.lastChild);e.remove()}else if(e.childNodes.length>0)for(var t=0,r=Array.from(e.childNodes);t<r.length;t++){var n=r[t];this.removeAllMark(n)}}},{key:"copyRightNode",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.markTagStyle,i=this.markTagAttr,a=document.createElement(e.tagName);if(n)for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&e.style[l]&&(a.style[l]=e.style[l]);if(i)for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&e.style[s]&&(a[s]=e[s]);for(;e.lastChild&&e.lastChild!==t&&!o(e.lastChild,t);)a.prepend(e.lastChild);return r&&e.lastChild===t?a.prepend(t):o(e.lastChild,t)&&a.prepend(this.copyRightNode(e.lastChild,t,r)||""),a.firstChild?a:null}},{key:"getRange",value:function(){var e,t=getSelection();return"None"===t.type?this.historyRange.length>0?e=this.historyRange.at(-1):(this.root.focus(),e=(t=getSelection()).getRangeAt(0)):(e=t.getRangeAt(0),v(this.root,e)||(this.historyRange.length>0?e=this.historyRange.at(-1):(this.root.focus(),e=(t=getSelection()).getRangeAt(0)))),{root:this.root,range:e,startNode:e.startContainer,endNode:e.endContainer,commonNode:e.commonAncestorContainer}}},{key:"setLink",value:function(e){this.historyRange.length&&this.setTextStyle("a",null,{href:e})}},{key:"setTextStyle",value:function(e,t,r){var n=this.tempNodeList;this.markTag=e,this.markTagStyle=t,this.markTagAttr=r;var a=this.getRange(),s=a.root,d=a.range,h=a.commonNode,c=a.startNode,u=a.endNode,v=h.childNodes,p=d.startOffset,g=d.endOffset,m=0,y=0;if(3===c.nodeType){if(d.collapsed){var C=document.createTextNode(f);if(this.hasActive(c)){var k=this.getActiveNode(c);if(p===c.length){for(var b=c;l(b)&&b!==k;)b=b.parentElement;if(b!==k&&k.after(this.copyRightNode(k,b.nextSibling,!0)||""),c.textContent===f&&n.length>0&&n.some((function(t){return t instanceof HTMLElement&&t.tagName.toLowerCase()===e}))){var T=n.find((function(t){return t instanceof HTMLElement&&t.tagName===e}));return null==T||T.remove(),void n.push(C)}k.after(C)}else 0===p?k.before(C):(c=c.splitText(p),k.after(this.copyRightNode(k,c,!0)),k.after(C));n.push(C)}else{var M=this.createMarkTag();(c=c.splitText(p)).previousSibling.after(M),M.appendChild(C),n.push(M)}return d.setStart(C,1),d.setEnd(C,1),void s.focus()}if(c===u){var E;g<u.length&&u.splitText(g),p>0&&(c=c.splitText(p));for(var N=!1,A=c.parentElement;A!==s;){if(this.isActive(A)){N=!0;break}A=A.parentElement}if(N){for(var S=this.createMarkTag();A.lastChild&&A.lastChild!==c&&!o(A.lastChild,c);)S.prepend(A.lastChild);S.firstChild&&A.after(S),A.lastChild!==c&&this.addRightMark(A.lastChild,c),A.after(A.lastChild),A.firstChild||A.remove()}else{var R=this.createMarkTag();c.after(R),R.appendChild(c)}return d.setStart(c,0),d.setEnd(c,c.length),null===(E=c.parentElement)||void 0===E||E.normalize(),void s.focus()}g<u.length&&(u=u.splitText(g).previousSibling),p>0&&(c=c.splitText(p));for(var x=0;x<v.length;x++)if((v[x]===c||o(v[x],c))&&(m=x),v[x]===u||o(v[x],u)){y=x;break}for(var L=Array.from(v).slice(m,y+1),O=!1,w=!1,j=c.parentElement;j!==s;){if(this.isActive(j)){O=!0;break}j=j.parentElement}for(var H=u.parentElement;H!==s;){if(this.isActive(H)){w=!0;break}H=H.parentElement}if(O||w)if(j===H)this.removeSelectedMark(j,c,u);else{var P=L.shift();O?(this.removeSiblingsMark(P,j,"right"),this.removeRightMark(j,c)):this.removeSiblingsMark(P,c,"right");var I=L.pop();w?(this.removeSiblingsMark(I,H),this.removeLeftMark(H,u)):this.removeSiblingsMark(I,u);var z,B=i(L);try{for(B.s();!(z=B.n()).done;){var D=z.value;this.removeAllMark(D)}}catch(e){B.e(e)}finally{B.f()}}else{this.addStartMark(L.shift(),c),this.addEndMark(L.pop(),u);var $,_=i(L);try{for(_.s();!($=_.n()).done;){var F=$.value;this.addMark(F)}}catch(e){_.e(e)}finally{_.f()}}d.setStart(c,0),d.setEnd(u,u.length),s.normalize(),s.focus()}}},{key:"setParagraphStyle",value:function(e,t){var r=this.getRange(),n=r.root,i=r.commonNode,a=r.startNode,l=r.endNode,s=i.childNodes,d=0,f=0;if(i===n){for(var h=0;h<s.length;h++)if((s[h]===a||o(s[h],a))&&(d=h),s[h]===l||o(s[h],l)){f=h;break}for(var c=d;c<=f;c++)s[c].style[e]=t}else{for(var u=i;u.parentElement!==n;)u=u.parentElement;u.style[e]=t}n.focus()}},{key:"insertElement",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=this.getRange(),a=i.root,o=i.range,s=i.startNode,d=i.endNode,c=i.commonNode,u=o.startOffset,v=o.endOffset;if(t="string"==typeof e?document.createElement(e):e,Object.keys(r).forEach((function(e){t.setAttribute(e,r[e])})),Object.keys(n).forEach((function(e){t.style[e]=n[e]})),o.collapsed){var p=s;if(0===u)for(;p!==a&&p.parentElement!==a;)p=p.parentElement;else if(u===s.length){for(;l(p)&&p!==a&&p.parentElement!==a;)p=p.parentElement;if(p.parentElement!==a){var g=p;for(p=p.parentElement;p.parentElement!==a;)p=p.parentElement;p.after(this.copyRightNode(p,g)||"")}}else{for(;p!==a&&p.parentElement!==a;)p=p.parentElement;var m;s===d?(d.splitText(v),m=s.splitText(u)):m=d.splitText(v).previousSibling,p.after(this.copyRightNode(p,m)||"")}p.after(t)}else if(c===a)o.deleteContents(),o.insertNode(t);else{for(var y,C=s;C.parentElement!==a;)C=C.parentElement;s===d?(d.splitText(v),y=s.splitText(u)):y=d.splitText(v).previousSibling,o.deleteContents(),C.after(this.copyRightNode(C,y)||""),C.after(t)}if(t.parentNode&&null===t.nextSibling){var k=document.createElement(h);k.appendChild(document.createTextNode(f)),t.after(k)}a.focus()}},{key:"setEditorContent",value:function(e){this.root.innerHTML=e}},{key:"clear",value:function(){this.root.innerHTML="",this.root.focus()}}],g&&t(n.prototype,g),Object.defineProperty(n,"prototype",{writable:!1}),e}();e.addInsertTagType=function(e){s.push(e)},e.default=g,e.setAutoFocus=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];d=e},e.setBlockTag=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div";h=e},e.setPlaceholderContent=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"请输入...";p=e},Object.defineProperty(e,"__esModule",{value:!0})}));