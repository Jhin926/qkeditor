!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).QkEditor=t()}(this,(function(){"use strict";function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function i(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(e){if("string"==typeof e)return r(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,l=!0,s=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return l=e.done,e},e:function(e){s=!0,o=e},f:function(){try{l||null==i.return||i.return()}finally{if(s)throw o}}}}function n(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=e.lastChild;setTimeout((function(){var e=new Range;e.setStart(r,1),e.setEnd(r,1),(t=t||getSelection())&&(t.removeAllRanges(),t.addRange(e))}),100)}function a(e,t){for(var r=t.parentNode;r;){if(r===e)return!0;null!==r&&(r=r.parentNode)}return!1}function o(e,t){var r=t.commonAncestorContainer;return e===r||a(e,r)}function l(e){var t,r;return null===(t=e.parentElement)||void 0===t||t.normalize(),(null===(r=e.parentElement)||void 0===r?void 0:r.lastChild)===e}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"div";return""===e.innerHTML||"<br>"===e.innerHTML||e.innerHTML==="<".concat(t,"><br></").concat(t,">")}var d=["img","hr","table"],f="\ufeff";function h(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"div";return e.innerHTML==="<".concat(t,">").concat(f,"</").concat(t,">")}function c(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",t=document.createElement(e),r=document.createTextNode(f);return t.appendChild(r),t}var v={autoFocus:!1,blockTag:"div",placeholderText:"请输入..."},u=function(){function r(e,i){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),t(this,"blockTag","div"),t(this,"historyRange",[]);var l=Object.assign({},v,i);this.blockTag=l.blockTag;var d="string"==typeof e?document.getElementById(e):e;if(d){d.style.position="relative";var f=document.createElement("div");f.contentEditable="true",f.style.cssText="\n                                    height: 100%;\n                                    outline: none;\n                                    overflow-y: auto;\n                                    padding: 20px;",d.appendChild(f),this.root=f;var u=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"请输入...",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"div",r=document.createElement(t);return r.style.cssText="position: absolute;\n                                    left: 20px;\n                                    top: 20px;\n                                    color: gray;\n                                    pointer-events: none;\n                                    position: absolute;",r.appendChild(document.createTextNode(e)),r}(l.placeholderText,l.blockTag);f.after(u),this.placeholder=u;var p=c(this.blockTag);f.appendChild(p),l.autoFocus&&n(p);var g=new MutationObserver((function(){!function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div";if(s(t,r)){e.style.display="block",t.firstChild&&t.firstChild.remove();var i=c(r);t.appendChild(i),n(i)}else h(t,r)||(e.style.display="none")}(a.placeholder,f,l.blockTag);var e=l.onChange;e&&"function"==typeof e&&e(h(f,a.blockTag)?"":f.innerHTML)}));g.observe(f,{childList:!0,attributes:!0,subtree:!0,characterData:!0}),this.root.addEventListener("keydown",(function(e){if("Enter"===e.key){var t=getSelection(),r=t.getRangeAt(0);if(r.commonAncestorContainer===a.root){e.preventDefault();var i=a.root.childNodes[r.startOffset],o=c(l.blockTag);a.root.insertBefore(o,i),n(o,t)}}})),document.addEventListener("selectionchange",(function(){var e=getSelection();if(e&&"None"!==e.type){var t=e.getRangeAt(0);o(a.root,t)&&(a.historyRange.length>20&&a.historyRange.shift(),a.historyRange.push(t))}}))}else console.error("dom不存在！")}var u,p;return u=r,p=[{key:"isActive",value:function(e){var t,r=this.markTag,i=this.markTagStyle,n=this.markTagAttr;if(3===e.nodeType)return!1;if(e instanceof HTMLElement&&e.tagName.toLowerCase()===r){if(i)for(var a in i)if(e.style[a]!==i[a]&&!(i[a].indexOf("#")>-1&&e.style[a]===(t=i[a],t.replace(/^#(\w{2})(\w{2})(\w{2})$/g,(function(e,t,r,i){return"rgb(".concat(parseInt(t,16),", ").concat(parseInt(r,16),", ").concat(parseInt(i,16),")")})))))return!1;if(n)for(var o in n)if(e[o]!==n[o])return!1;return!0}return!1}},{key:"hasActive",value:function(e){for(var t=e;!this.isActive(t)&&t!==this.root;)t=t.parentElement;return t!==this.root}},{key:"getActiveNode",value:function(e){for(var t=e.parentElement;!this.isActive(t);)t=t.parentElement;return t}},{key:"createMarkTag",value:function(){var e=this.markTag,t=this.markTagStyle,r=this.markTagAttr,i=document.createElement(e);if(t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(i.style[n]=t[n]);if(r)for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(i[a]=r[a]);return i}},{key:"removeSiblingsMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"left",i="left"===r?e.firstChild:e.lastChild;i&&i!==t&&!a(i,t);){var n="left"===r?i.nextSibling:i.previousSibling;this.removeAllMark(i),i=n}i&&a(i,t)&&this.removeSiblingsMark(i,t,r)}},{key:"addStartMark",value:function(e,t){if(e===t){var r=this.createMarkTag();t.after(r),r.appendChild(t)}else this.removeSiblingsMark(e,t,"right"),this.addRightMark(e,t,!0)}},{key:"addEndMark",value:function(e,t){if(e===t){var r=this.createMarkTag();t.after(r),r.appendChild(t)}else this.removeSiblingsMark(e,t),this.addLeftMark(e,t,!0)}},{key:"addMark",value:function(e){if(3===e.nodeType){var t=this.createMarkTag();e.after(t),t.appendChild(e)}else if(!this.isActive(e)){if(d.indexOf(e.tagName.toLocaleLowerCase())>-1)return;this.removeAllMark(e);for(var r=this.createMarkTag();e.firstChild;)r.appendChild(e.firstChild);e.appendChild(r)}}},{key:"addLeftMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.createMarkTag();e.firstChild&&e.firstChild!==t&&!a(e.firstChild,t);)i.appendChild(e.firstChild);e.firstChild!==t?this.addLeftMark(e.firstChild,t,r):r&&i.appendChild(t),i.firstChild&&e.prepend(i)}},{key:"addRightMark",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.createMarkTag();e.lastChild&&e.lastChild!==t&&!a(e.lastChild,t);)i.prepend(e.lastChild);e.lastChild!==t?this.addRightMark(e.lastChild,t,r):r&&i.prepend(t),i.firstChild&&e.appendChild(i)}},{key:"removeRightMark",value:function(e,t){for(;e.lastChild&&e.lastChild!==t&&!a(e.lastChild,t);)e.after(e.lastChild);e.lastChild!==t&&this.addLeftMark(e.lastChild,t),e.after(e.lastChild),e.firstChild||e.remove()}},{key:"removeLeftMark",value:function(e,t){for(;e.firstChild&&e.firstChild!==t&&!a(e.firstChild,t);)e.before(e.firstChild);e.firstChild!==t&&this.addRightMark(e.firstChild,t),e.before(e.firstChild),e.firstChild||e.remove()}},{key:"removeSelectedMark",value:function(e,t,r){for(var i=this.createMarkTag();e.lastChild&&e.lastChild!==r&&!a(e.lastChild,r);)i.prepend(e.lastChild);for(i.firstChild&&e.after(i),e.lastChild!==r&&this.addRightMark(e.lastChild,r);e.lastChild&&e.lastChild!==t&&!a(e.lastChild,t);)e.after(e.lastChild);e.lastChild!==t&&this.addLeftMark(e.lastChild,t),e.after(e.lastChild),e.firstChild||e.remove()}},{key:"removeAllMark",value:function(e){if(3!==e.nodeType)if(this.isActive(e)){for(;e.lastChild;)e.after(e.lastChild);e.remove()}else if(e.childNodes.length>0)for(var t=0,r=Array.from(e.childNodes);t<r.length;t++){var i=r[t];this.removeAllMark(i)}}},{key:"copyRightNode",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.markTagStyle,n=this.markTagAttr,o=document.createElement(e.tagName);if(i)for(var l in i)Object.prototype.hasOwnProperty.call(i,l)&&e.style[l]&&(o.style[l]=e.style[l]);if(n)for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&e.style[s]&&(o[s]=e[s]);for(;e.lastChild&&e.lastChild!==t&&!a(e.lastChild,t);)o.prepend(e.lastChild);return r&&e.lastChild===t?o.prepend(t):a(e.lastChild,t)&&o.prepend(this.copyRightNode(e.lastChild,t,r)||""),o.firstChild?o:null}},{key:"setRange",value:function(){var e;return this.historyRange.length>0?e=this.historyRange.at(-1):(this.root.focus(),e=getSelection().getRangeAt(0)),e}},{key:"getRange",value:function(){var e,t=getSelection();return"None"===t.type?e=this.setRange():(e=t.getRangeAt(0),o(this.root,e)||(e=this.setRange())),{root:this.root,range:e,startNode:e.startContainer,endNode:e.endContainer,commonNode:e.commonAncestorContainer}}},{key:"setTextStyle",value:function(e,t,r){this.markTag=e,this.markTagStyle=t,this.markTagAttr=r;var n=this.getRange(),o=n.root,s=n.range,d=n.commonNode,h=n.startNode,c=n.endNode,v=d.childNodes,u=s.startOffset,p=s.endOffset,g=0,m=0;if(3===h.nodeType){if(s.collapsed){var y=document.createTextNode(f);if(this.hasActive(h)){var k=this.getActiveNode(h);if(u===h.length){for(var C=h;l(C)&&C!==k;)C=C.parentElement;C!==k&&k.after(this.copyRightNode(k,C.nextSibling,!0)||""),k.after(y)}else 0===u?k.before(y):(h=h.splitText(u),k.after(this.copyRightNode(k,h,!0)),k.after(y))}else{var b=this.createMarkTag();(h=h.splitText(u)).previousSibling.after(b),b.appendChild(y)}return s.setStart(y,1),s.setEnd(y,1),void o.focus()}if(h===c){var T;p<c.length&&c.splitText(p),u>0&&(h=h.splitText(u));for(var M=!1,E=h.parentElement;E!==o;){if(this.isActive(E)){M=!0;break}E=E.parentElement}if(M){for(var S=this.createMarkTag();E.lastChild&&E.lastChild!==h&&!a(E.lastChild,h);)S.prepend(E.lastChild);S.firstChild&&E.after(S),E.lastChild!==h&&this.addRightMark(E.lastChild,h),E.after(E.lastChild),E.firstChild||E.remove()}else{var N=this.createMarkTag();h.after(N),N.appendChild(h)}return s.setStart(h,0),s.setEnd(h,h.length),null===(T=h.parentElement)||void 0===T||T.normalize(),void o.focus()}p<c.length&&(c=c.splitText(p).previousSibling),u>0&&(h=h.splitText(u));for(var A=0;A<v.length;A++)if((v[A]===h||a(v[A],h))&&(g=A),v[A]===c||a(v[A],c)){m=A;break}for(var R=Array.from(v).slice(g,m+1),x=!1,O=!1,w=h.parentElement;w!==o;){if(this.isActive(w)){x=!0;break}w=w.parentElement}for(var L=c.parentElement;L!==o;){if(this.isActive(L)){O=!0;break}L=L.parentElement}if(x||O)if(w===L)this.removeSelectedMark(w,h,c);else{var j=R.shift();x?(this.removeSiblingsMark(j,w,"right"),this.removeRightMark(w,h)):this.removeSiblingsMark(j,h,"right");var H=R.pop();O?(this.removeSiblingsMark(H,L),this.removeLeftMark(L,c)):this.removeSiblingsMark(H,c);var P,I=i(R);try{for(I.s();!(P=I.n()).done;){var z=P.value;this.removeAllMark(z)}}catch(e){I.e(e)}finally{I.f()}}else{this.addStartMark(R.shift(),h),this.addEndMark(R.pop(),c);var B,D=i(R);try{for(D.s();!(B=D.n()).done;){var F=B.value;this.addMark(F)}}catch(e){D.e(e)}finally{D.f()}}s.setStart(h,0),s.setEnd(c,c.length),o.normalize(),o.focus()}}},{key:"setParagraphStyle",value:function(e,t){var r=this.getRange(),i=r.root,n=r.commonNode,o=r.startNode,l=r.endNode,s=n.childNodes,d=0,f=0;if(n===i){for(var h=0;h<s.length;h++)if((s[h]===o||a(s[h],o))&&(d=h),s[h]===l||a(s[h],l)){f=h;break}for(var c=d;c<=f;c++)s[c].style[e]=t}else{for(var v=n;v.parentElement!==i;)v=v.parentElement;v.style[e]=t}i.focus()}},{key:"insertElement",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=this.getRange(),a=n.root,o=n.range,s=n.startNode,d=n.endNode,h=n.commonNode,c=o.startOffset,v=o.endOffset;if(t="string"==typeof e?document.createElement(e):e,Object.keys(r).forEach((function(e){t.setAttribute(e,r[e])})),Object.keys(i).forEach((function(e){t.style[e]=i[e]})),o.collapsed){var u=s;if(0===c)for(;u!==a&&u.parentElement!==a;)u=u.parentElement;else if(c===s.length){for(;l(u)&&u!==a&&u.parentElement!==a;)u=u.parentElement;if(u.parentElement!==a){var p=u;for(u=u.parentElement;u.parentElement!==a;)u=u.parentElement;u.after(this.copyRightNode(u,p)||"")}}else{for(;u!==a&&u.parentElement!==a;)u=u.parentElement;var g;s===d?(d.splitText(v),g=s.splitText(c)):g=d.splitText(v).previousSibling,u.after(this.copyRightNode(u,g)||"")}u.after(t)}else if(h===a)o.deleteContents(),o.insertNode(t);else{for(var m,y=s;y.parentElement!==a;)y=y.parentElement;s===d?(d.splitText(v),m=s.splitText(c)):m=d.splitText(v).previousSibling,o.deleteContents(),y.after(this.copyRightNode(y,m)||""),y.after(t)}if(t.parentNode&&null===t.nextSibling){var k=document.createElement(this.blockTag);k.appendChild(document.createTextNode(f)),t.after(k)}a.focus()}},{key:"setEditorContent",value:function(e){this.root.innerHTML=e}},{key:"clear",value:function(){this.root.innerHTML="",this.root.focus()}}],p&&e(u.prototype,p),Object.defineProperty(u,"prototype",{writable:!1}),r}();return u}));